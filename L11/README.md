# ДЗ для курса "Разработчик Java" в OTUS


#### Домашнее задание

На основе ДЗ10:
- [x] 1. Оформить решение в виде DBService (interface DBService, class DBServiceImpl, UsersDAO, UsersDataSet, ~Executor~)
- [x] 2. _Не меняя_ интерфейс DBSerivice сделать DBServiceHibernateImpl на Hibernate.
- [x] 3. Добавить в UsersDataSet поля:

адрес (OneToOne) 
```
class AddressDataSet{
    private String street;
}
```

и телефон (OneToMany)
```
class PhoneDataSet{
    private String number;
}
```

Добавить соответствущие датасеты и DAO. 

##### Материалы

[Why is Hibernate Open Session in View considered a bad practice?](https://stackoverflow.com/questions/1103363/why-is-hibernate-open-session-in-view-considered-a-bad-practice)
[The OpenSessionInView antipattern](https://blog.frankel.ch/the-opensessioninview-antipattern/)
[Open Session in View](https://developer.jboss.org/wiki/OpenSessionInView)
[what is current_session_context_class in hibernate configuration xml](http://rbyjava.blogspot.com/2012/05/what-is-currentsessioncontextclass-in.html)
[HibernateException: No Hibernate Session Bound to Thread in Hibernate 3](https://www.baeldung.com/no-hibernate-session-bound-to-thread-exception)
[Hibernate openSession() vs getCurrentSession()](https://stackoverflow.com/questions/8046662/hibernate-opensession-vs-getcurrentsession)

##### Решение

``` 
/usr/lib/jvm/java-10-oracle/bin/java ...
23:57:20.800 [main] INFO  org.hibernate.Version - HHH000412: Hibernate Core {5.3.7.Final}
23:57:20.805 [main] INFO  org.hibernate.cfg.Environment - HHH000206: hibernate.properties not found
23:57:20.957 [main] INFO  o.h.annotations.common.Version - HCANN000001: Hibernate Commons Annotations {5.0.4.Final}
23:57:21.156 [main] WARN  o.hibernate.orm.connections.pooling - HHH10001002: Using Hibernate built-in connection pool (not for production use!)
23:57:21.180 [main] INFO  o.hibernate.orm.connections.pooling - HHH10001005: using driver [org.h2.Driver] at URL [jdbc:h2:mem:test;DB_CLOSE_DELAY=-1]
23:57:21.181 [main] INFO  o.hibernate.orm.connections.pooling - HHH10001001: Connection properties: {password=sa, user=sa}
23:57:21.181 [main] INFO  o.hibernate.orm.connections.pooling - HHH10001003: Autocommit mode: false
23:57:21.183 [main] INFO  o.h.e.j.c.i.DriverManagerConnectionProviderImpl - HHH000115: Hibernate connection pool size: 20 (min=1)
23:57:21.428 [main] INFO  org.hibernate.dialect.Dialect - HHH000400: Using dialect: org.hibernate.dialect.H2Dialect
Hibernate: drop table address if exists
23:57:22.272 [main] INFO  org.hibernate.orm.connections.access - HHH10001501: Connection obtained from JdbcConnectionAccess [org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator$ConnectionProviderJdbcConnectionAccess@1386313f] for (non-JTA) DDL execution was not in auto-commit mode; the Connection 'local transaction' will be committed and the Connection will be set into auto-commit mode.
Hibernate: drop table phones if exists
Hibernate: drop table users if exists
Hibernate: create table address (id bigint generated by default as identity, street varchar(255), user_id bigint not null, primary key (id))
23:57:22.276 [main] INFO  org.hibernate.orm.connections.access - HHH10001501: Connection obtained from JdbcConnectionAccess [org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator$ConnectionProviderJdbcConnectionAccess@2440022a] for (non-JTA) DDL execution was not in auto-commit mode; the Connection 'local transaction' will be committed and the Connection will be set into auto-commit mode.
Hibernate: create table phones (id bigint generated by default as identity, phone varchar(255), user_id bigint not null, primary key (id))
Hibernate: create table users (DTYPE varchar(31) not null, id bigint generated by default as identity, age integer not null, name varchar(255), armedBy varchar(255), primary key (id))
Hibernate: alter table address add constraint UK_7rod8a71yep5vxasb0ms3osbg unique (user_id)
Hibernate: alter table address add constraint FK6i66ijb8twgcqtetl8eeeed6v foreign key (user_id) references users
Hibernate: alter table phones add constraint FKmg6d77tgqfen7n1g763nvsqe3 foreign key (user_id) references users
23:57:22.307 [main] INFO  o.h.t.s.internal.SchemaCreatorImpl - HHH000476: Executing import script 'org.hibernate.tool.schema.internal.exec.ScriptSourceInputNonExistentImpl@e146f93'
23:57:22.399 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - 
	Connected to:	jdbc:h2:mem:test
	DB name:	H2
	DB version:	1.4.197 (2018-03-18)
	Driver:		H2 JDBC Driver
Hibernate: insert into users (id, age, name, DTYPE) values (null, ?, ?, 'UserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
Hibernate: insert into users (id, age, name, DTYPE) values (null, ?, ?, 'UserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
Hibernate: insert into users (id, age, name, DTYPE) values (null, ?, ?, 'UserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
Hibernate: insert into users (id, age, name, armedBy, DTYPE) values (null, ?, ?, ?, 'UberUserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
23:57:22.467 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ---------------------------------FIND OBJ BY NAME FIELD---------------------------------
23:57:22.506 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UserDataSet(super=DataSet(id=2), name=Test Two, age=22, phones=[PhoneDataSet(super=DataSet(id=2), phone=+5 5555 555 550)], address=AddressDataSet(super=DataSet(id=2), street=pr.Lenina 111))
23:57:22.556 [main] INFO  o.h.h.i.QueryTranslatorFactoryInitiator - HHH000397: Using ASTQueryTranslatorFactory
Hibernate: select userdatase0_.id as id2_2_, userdatase0_.age as age3_2_, userdatase0_.name as name4_2_, userdatase0_.armedBy as armedBy5_2_, userdatase0_.DTYPE as DTYPE1_2_ from users userdatase0_ where userdatase0_.name=?
Hibernate: select addressdat0_.id as id1_0_1_, addressdat0_.street as street2_0_1_, addressdat0_.user_id as user_id3_0_1_, userdatase1_.id as id2_2_0_, userdatase1_.age as age3_2_0_, userdatase1_.name as name4_2_0_, userdatase1_.armedBy as armedBy5_2_0_, userdatase1_.DTYPE as DTYPE1_2_0_ from address addressdat0_ inner join users userdatase1_ on addressdat0_.user_id=userdatase1_.id where addressdat0_.user_id=?
Hibernate: select phones0_.user_id as user_id3_1_0_, phones0_.id as id1_1_0_, phones0_.id as id1_1_1_, phones0_.phone as phone2_1_1_, phones0_.user_id as user_id3_1_1_ from phones phones0_ where phones0_.user_id=?
23:57:22.707 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: UserDataSet(super=DataSet(id=2), name=Test Two, age=22, phones=[PhoneDataSet(super=DataSet(id=2), phone=+5 5555 555 550)], address=AddressDataSet(super=DataSet(id=2), street=pr.Lenina 111))

Process finished with exit code 0

```


``` 
/usr/lib/jvm/java-10-oracle/bin/java ...
21:45:08.547 [main] INFO  org.hibernate.Version - HHH000412: Hibernate Core {5.3.7.Final}
21:45:08.551 [main] INFO  org.hibernate.cfg.Environment - HHH000206: hibernate.properties not found
21:45:08.701 [main] INFO  o.h.annotations.common.Version - HCANN000001: Hibernate Commons Annotations {5.0.4.Final}
21:45:08.855 [main] WARN  o.hibernate.orm.connections.pooling - HHH10001002: Using Hibernate built-in connection pool (not for production use!)
21:45:08.864 [main] INFO  o.hibernate.orm.connections.pooling - HHH10001005: using driver [org.h2.Driver] at URL [jdbc:h2:~/test]
21:45:08.865 [main] INFO  o.hibernate.orm.connections.pooling - HHH10001001: Connection properties: {password=sa, user=sa}
21:45:08.865 [main] INFO  o.hibernate.orm.connections.pooling - HHH10001003: Autocommit mode: false
21:45:08.868 [main] INFO  o.h.e.j.c.i.DriverManagerConnectionProviderImpl - HHH000115: Hibernate connection pool size: 20 (min=1)
21:45:09.132 [main] INFO  org.hibernate.dialect.Dialect - HHH000400: Using dialect: org.hibernate.dialect.H2Dialect
Hibernate: drop table address if exists
21:45:10.032 [main] INFO  org.hibernate.orm.connections.access - HHH10001501: Connection obtained from JdbcConnectionAccess [org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator$ConnectionProviderJdbcConnectionAccess@43984213] for (non-JTA) DDL execution was not in auto-commit mode; the Connection 'local transaction' will be committed and the Connection will be set into auto-commit mode.
Hibernate: drop table phones if exists
Hibernate: drop table users if exists
Hibernate: create table address (id bigint generated by default as identity, street varchar(255), user_id bigint not null, primary key (id))
21:45:10.053 [main] INFO  org.hibernate.orm.connections.access - HHH10001501: Connection obtained from JdbcConnectionAccess [org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator$ConnectionProviderJdbcConnectionAccess@6f798482] for (non-JTA) DDL execution was not in auto-commit mode; the Connection 'local transaction' will be committed and the Connection will be set into auto-commit mode.
Hibernate: create table phones (id bigint generated by default as identity, phone varchar(255), user_id bigint not null, primary key (id))
Hibernate: create table users (DTYPE varchar(31) not null, id bigint generated by default as identity, age integer not null, name varchar(255), armedBy varchar(255), primary key (id))
Hibernate: alter table address add constraint UK_7rod8a71yep5vxasb0ms3osbg unique (user_id)
Hibernate: alter table address add constraint FK6i66ijb8twgcqtetl8eeeed6v foreign key (user_id) references users
Hibernate: alter table phones add constraint FKmg6d77tgqfen7n1g763nvsqe3 foreign key (user_id) references users
21:45:10.077 [main] INFO  o.h.t.s.internal.SchemaCreatorImpl - HHH000476: Executing import script 'org.hibernate.tool.schema.internal.exec.ScriptSourceInputNonExistentImpl@76b47204'
21:45:10.171 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - 
	Connected to:	jdbc:h2:~/test
	DB name:	H2
	DB version:	1.4.197 (2018-03-18)
	Driver:		H2 JDBC Driver
Hibernate: insert into users (id, age, name, DTYPE) values (null, ?, ?, 'UserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
Hibernate: insert into users (id, age, name, DTYPE) values (null, ?, ?, 'UserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
Hibernate: insert into users (id, age, name, DTYPE) values (null, ?, ?, 'UserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
Hibernate: insert into users (id, age, name, armedBy, DTYPE) values (null, ?, ?, ?, 'UberUserDataSet')
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into phones (id, phone, user_id) values (null, ?, ?)
Hibernate: insert into address (id, street, user_id) values (null, ?, ?)
21:45:10.236 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ---------------------------------LOAD---------------------------------
21:45:10.308 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UserDataSet(super=DataSet(id=1), name=Test One, age=11, phones=[PhoneDataSet(super=DataSet(id=1), phone=+5 5555 555 555)], address=AddressDataSet(super=DataSet(id=1), street=pr.Lenina 1))
Hibernate: select userdatase0_.id as id2_2_0_, userdatase0_.age as age3_2_0_, userdatase0_.name as name4_2_0_, userdatase0_.armedBy as armedBy5_2_0_, userdatase0_.DTYPE as DTYPE1_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users userdatase0_ left outer join address addressdat1_ on userdatase0_.id=addressdat1_.user_id where userdatase0_.id=?
Hibernate: select phones0_.user_id as user_id3_1_0_, phones0_.id as id1_1_0_, phones0_.id as id1_1_1_, phones0_.phone as phone2_1_1_, phones0_.user_id as user_id3_1_1_ from phones phones0_ where phones0_.user_id=?
21:45:10.328 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: UserDataSet(super=DataSet(id=1), name=Test One, age=11, phones=[PhoneDataSet(super=DataSet(id=1), phone=+5 5555 555 555)], address=AddressDataSet(super=DataSet(id=1), street=pr.Lenina 1))
21:45:10.331 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ------------------------------------------------------------------
21:45:10.332 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UserDataSet(super=DataSet(id=2), name=Test Two, age=22, phones=[PhoneDataSet(super=DataSet(id=2), phone=+5 5555 555 550)], address=AddressDataSet(super=DataSet(id=2), street=pr.Lenina 111))
Hibernate: select userdatase0_.id as id2_2_0_, userdatase0_.age as age3_2_0_, userdatase0_.name as name4_2_0_, userdatase0_.armedBy as armedBy5_2_0_, userdatase0_.DTYPE as DTYPE1_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users userdatase0_ left outer join address addressdat1_ on userdatase0_.id=addressdat1_.user_id where userdatase0_.id=?
Hibernate: select phones0_.user_id as user_id3_1_0_, phones0_.id as id1_1_0_, phones0_.id as id1_1_1_, phones0_.phone as phone2_1_1_, phones0_.user_id as user_id3_1_1_ from phones phones0_ where phones0_.user_id=?
21:45:10.339 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: UserDataSet(super=DataSet(id=2), name=Test Two, age=22, phones=[PhoneDataSet(super=DataSet(id=2), phone=+5 5555 555 550)], address=AddressDataSet(super=DataSet(id=2), street=pr.Lenina 111))
21:45:10.340 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ------------------------------------------------------------------
21:45:10.340 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UserDataSet(super=DataSet(id=3), name=Test Three, age=33, phones=[PhoneDataSet(super=DataSet(id=3), phone=+5 5555 555 505)], address=AddressDataSet(super=DataSet(id=3), street=str.Vano 10))
Hibernate: select userdatase0_.id as id2_2_0_, userdatase0_.age as age3_2_0_, userdatase0_.name as name4_2_0_, userdatase0_.armedBy as armedBy5_2_0_, userdatase0_.DTYPE as DTYPE1_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users userdatase0_ left outer join address addressdat1_ on userdatase0_.id=addressdat1_.user_id where userdatase0_.id=?
Hibernate: select phones0_.user_id as user_id3_1_0_, phones0_.id as id1_1_0_, phones0_.id as id1_1_1_, phones0_.phone as phone2_1_1_, phones0_.user_id as user_id3_1_1_ from phones phones0_ where phones0_.user_id=?
21:45:10.348 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: UserDataSet(super=DataSet(id=3), name=Test Three, age=33, phones=[PhoneDataSet(super=DataSet(id=3), phone=+5 5555 555 505)], address=AddressDataSet(super=DataSet(id=3), street=str.Vano 10))
21:45:10.348 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ------------------------------------------------------------------
21:45:10.348 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ---------------------------------GET NAME FIELD---------------------------------
21:45:10.349 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UserDataSet(super=DataSet(id=3), name=Test Three, age=33, phones=[PhoneDataSet(super=DataSet(id=3), phone=+5 5555 555 505)], address=AddressDataSet(super=DataSet(id=3), street=str.Vano 10))
Hibernate: select userdatase0_.id as id2_2_0_, userdatase0_.age as age3_2_0_, userdatase0_.name as name4_2_0_, userdatase0_.armedBy as armedBy5_2_0_, userdatase0_.DTYPE as DTYPE1_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users userdatase0_ left outer join address addressdat1_ on userdatase0_.id=addressdat1_.user_id where userdatase0_.id=?
21:45:10.355 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: Test Three
21:45:10.355 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ---------------------------------DB NON-EXISTENT ID---------------------------------
Hibernate: select userdatase0_.id as id2_2_0_, userdatase0_.age as age3_2_0_, userdatase0_.name as name4_2_0_, userdatase0_.armedBy as armedBy5_2_0_, userdatase0_.DTYPE as DTYPE1_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users userdatase0_ left outer join address addressdat1_ on userdatase0_.id=addressdat1_.user_id where userdatase0_.id=?
21:45:10.356 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - null
21:45:10.357 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ---------------------------------SAVED BUT MODIFIED OBJ---------------------------------
21:45:10.357 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UserDataSet(super=DataSet(id=53), name=Test One, age=11, phones=[PhoneDataSet(super=DataSet(id=1), phone=+5 5555 555 555)], address=AddressDataSet(super=DataSet(id=1), street=pr.Lenina 1))
Hibernate: select userdatase0_.id as id2_2_0_, userdatase0_.age as age3_2_0_, userdatase0_.name as name4_2_0_, userdatase0_.armedBy as armedBy5_2_0_, userdatase0_.DTYPE as DTYPE1_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users userdatase0_ left outer join address addressdat1_ on userdatase0_.id=addressdat1_.user_id where userdatase0_.id=?
Hibernate: select phones0_.user_id as user_id3_1_0_, phones0_.id as id1_1_0_, phones0_.id as id1_1_1_, phones0_.phone as phone2_1_1_, phones0_.user_id as user_id3_1_1_ from phones phones0_ where phones0_.user_id=?
21:45:10.363 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: UserDataSet(super=DataSet(id=1), name=Test One, age=11, phones=[PhoneDataSet(super=DataSet(id=1), phone=+5 5555 555 555)], address=AddressDataSet(super=DataSet(id=1), street=pr.Lenina 1))
21:45:10.363 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ---------------------------------CHILD OBJ---------------------------------
21:45:10.365 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> origin: UberUserDataSet(super=UserDataSet(super=DataSet(id=4), name=Uber U, age=100, phones=[PhoneDataSet(super=DataSet(id=4), phone=000), PhoneDataSet(super=DataSet(id=5), phone=345), PhoneDataSet(super=DataSet(id=6), phone=999)], address=AddressDataSet(super=DataSet(id=4), street=USSR)), armedBy=pistol)
Hibernate: select uberuserda0_.id as id2_2_0_, uberuserda0_.age as age3_2_0_, uberuserda0_.name as name4_2_0_, uberuserda0_.armedBy as armedBy5_2_0_, addressdat1_.id as id1_0_1_, addressdat1_.street as street2_0_1_, addressdat1_.user_id as user_id3_0_1_ from users uberuserda0_ inner join address addressdat1_ on uberuserda0_.id=addressdat1_.user_id where uberuserda0_.id=? and uberuserda0_.DTYPE='UberUserDataSet'
Hibernate: select phones0_.user_id as user_id3_1_0_, phones0_.id as id1_1_0_, phones0_.id as id1_1_1_, phones0_.phone as phone2_1_1_, phones0_.user_id as user_id3_1_1_ from phones phones0_ where phones0_.user_id=?
21:45:10.375 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - >>>>>>> loaded: UberUserDataSet(super=UserDataSet(super=DataSet(id=4), name=Uber U, age=100, phones=[PhoneDataSet(super=DataSet(id=4), phone=000), PhoneDataSet(super=DataSet(id=5), phone=345), PhoneDataSet(super=DataSet(id=6), phone=999)], address=AddressDataSet(super=DataSet(id=4), street=USSR)), armedBy=pistol)
21:45:10.375 [main] INFO  r.o.s.L.d.DBServiceHibernateImplTest - ------------------------------------------------------------------

Process finished with exit code 0

```


